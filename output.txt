MIT License

Copyright (c) 2024 AI_Suggester

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
# AI Automation Suggester

An integration for Home Assistant that uses OpenAI's GPT models to analyze your newly added entities and suggest potential automations.

---

## Support the Project

If you find this project helpful and would like to support its development, you can buy me a coffee!

<a href="https://buymeacoffee.com/itspecialist">
  <img src="https://camo.githubusercontent.com/7b8f7343bfc6e3c65c7901846637b603fd812f1a5f768d8b0572558bde859eb9/68747470733a2f2f63646e2e6275796d6561636f666665652e636f6d2f627574746f6e732f76322f64656661756c742d79656c6c6f772e706e67" alt="Buy Me A Coffee" width="200">
</a>

Your support is greatly appreciated and helps maintain and improve this project!

---

## Table of Contents

- [Background and Purpose](#background-and-purpose)
- [Features](#features)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
- [Usage](#usage)
- [Important Notes](#important-notes)
- [Troubleshooting](#troubleshooting)
- [Roadmap](#roadmap)
  - [Phase 1: Enhanced Entity Analysis](#phase-1-enhanced-entity-analysis)
  - [Phase 2: Interactive Suggestion Management](#phase-2-interactive-suggestion-management)
  - [Phase 3: Automated Automation Creation](#phase-3-automated-automation-creation)
  - [Future Enhancements](#future-enhancements)
  - [Contributing to the Roadmap](#contributing-to-the-roadmap)
  - [Timeline and Updates](#timeline-and-updates)
- [License](#license)
- [Acknowledgments](#acknowledgments)
- [Contributions](#contributions)
- [Disclaimer](#disclaimer)
- [Support the Project](#support-the-project)

---

## Background and Purpose

Managing and automating devices in a smart home can be complex, especially as the number of devices grows. The **AI Automation Suggester** integration aims to simplify this process by leveraging OpenAI's GPT models to analyze newly added entities in your Home Assistant setup and provide intelligent automation suggestions. We call it the ultimate 'Matt' mode (only because he's the one who asked for it)

---

## Features

- **Automatic Analysis**: Periodically scans for new entities and analyzes them using AI.
- **Automation Suggestions**: Provides clear and concise suggestions for potential automations.
- **Manual Trigger**: Allows you to manually trigger the AI analysis at any time.
- **Persistent Notifications**: Suggestions are delivered via Home Assistant's persistent notifications.
- **Sensor Entity**: Creates a sensor entity to display the status and suggestions.
- **Configurable Scan Frequency**: Set how often the integration scans for new entities.
- **Supports OpenAI GPT Models**: Uses OpenAI's GPT models for analysis.
- **Local AI Option**: Placeholder for future local AI processing capabilities.

---

## Prerequisites

- **Home Assistant**: Version 2023.5 or later.
- **OpenAI API Key**: You need an OpenAI API key to use the cloud AI processing.

---

## Installation

### Method 1: Manual Installation (Recommended)

If you prefer to install the integration manually, follow these steps:

1. **Download the Integration**
   - Clone or download the `ai_automation_suggester` repository from GitHub.

2. **Copy to Home Assistant**
   - Place the `ai_suggester` directory inside the `custom_components` directory of your Home Assistant configuration folder.
   - Your directory structure should look like this:

     ```
     └── config/
         ├── configuration.yaml
         └── custom_components/
             └── ai_suggester/
                 ├── __init__.py
                 ├── config_flow.py
                 ├── const.py
                 ├── coordinator.py
                 ├── manifest.json
                 ├── sensor.py
                 ├── services.yaml
                 ├── strings.json
                 └── translations/
                     └── en.json
     ```

   - If the `custom_components` directory doesn't exist, create it.

3. **Restart Home Assistant**
   - After copying the files, restart Home Assistant to recognize the new integration.

---

## Configuration

### 1. **Add the Integration via Home Assistant UI**

- Navigate to **Settings** > **Devices & Services**.
- Click on **Add Integration**.
- Search for **AI Automation Suggester** and select it.

### 2. **Configure the Integration**

- **Scan Frequency (hours)**: Set how often (in hours) the integration scans for new entities. Default is `24` hours.
- **Use Local AI**: Option to use local AI processing (currently not implemented).
- **OpenAI API Key**: Enter your OpenAI API key. This is required if not using local AI.
- **AI Model**: Select your preferred AI model from the dropdown. Options include:

  - **gpt-3.5-turbo**: Cheap
  - **gpt-4o**: High Quality
  - **o1-mini**: Expensive
  - **gpt-4o-mini**: Recommended
  - **o1-preview**: Very Expensive

  **Note**: The choice of AI model affects the cost and quality of the suggestions. Higher-end models like `gpt-4o-mini` may provide better suggestions but at a higher cost.

### 3. **Obtain an OpenAI API Key**

- Log in or sign up at the [OpenAI Platform](https://platform.openai.com/).
- Navigate to the [API Keys page](https://platform.openai.com/account/api-keys).
- Click on **Create new secret key** and copy the key.
- **Important**: Keep your API key secure and do not share it publicly.

---

## Usage

### 1. **Automatic Suggestions**

- The integration will automatically scan for new entities based on the configured scan frequency.
- When new entities are detected, it will analyze them and create automation suggestions.

### 2. **Manual Trigger**

- You can manually trigger the AI analysis at any time:
  - Go to **Developer Tools** > **Services**.
  - Select `ai_suggester.generate_suggestions` from the list.
  - Click **Call Service**.

### 3. **Viewing Suggestions**

- Suggestions are delivered via Home Assistant's persistent notifications.
- You can also view suggestions in the `sensor.ai_automation_suggestions` entity's attributes.

### 4. **Adding to Lovelace Dashboard**

- You can display the suggestions on your dashboard using an **Entities** card:

  ```yaml
  type: entities
  entities:
    - entity: sensor.ai_automation_suggestions
  ```

---

## Important Notes

### **OpenAI API Key Security**

- **Do Not Share Your API Key**: Keep your OpenAI API key confidential.
- **Revoking Compromised Keys**: If you suspect your API key has been compromised, revoke it immediately and generate a new one.

### **OpenAI API Usage**

- **Costs**: Using the OpenAI API may incur costs. Monitor your usage in the [OpenAI Dashboard](https://platform.openai.com/account/usage).
- **Usage Limits**: Set usage limits in your OpenAI account to avoid unexpected charges.

### **Compatibility**

- **OpenAI Python Library**: The integration requires `openai>=1.0.0`. This is specified in the `manifest.json`.
- **Home Assistant Version**: Ensure you are running Home Assistant version 2023.5 or later.

### **Data Privacy**

- **Data Sent to OpenAI**: The integration sends entity information to OpenAI's API for analysis.
- **User Consent**: By using this integration, you consent to this data being sent to OpenAI.

### **Local AI Processing**

- **Not Yet Implemented**: The option to use local AI is currently a placeholder and not functional.
- **Future Updates**: Stay tuned for updates that may include local AI processing capabilities.

---

## Troubleshooting

### **Common Issues**

1. **OpenAI API Errors**

   - **Symptom**: Error messages related to OpenAI API in notifications or logs.
   - **Solution**:
     - Verify your OpenAI API key is correct.
     - Ensure your API key has not expired or been revoked.
     - Check your OpenAI account for any usage limits or account issues.

2. **Integration Not Showing Up**

   - **Symptom**: After installation, the integration doesn't appear in Home Assistant.
   - **Solution**:
     - Ensure the `ai_suggester` directory is in the correct location.
     - Restart Home Assistant after adding the custom component.
     - Check the logs for any errors during startup.

3. **No Suggestions Generated**

   - **Symptom**: The integration doesn't generate any suggestions.
   - **Solution**:
     - Manually trigger the service `ai_suggester.generate_suggestions`.
     - Check if there are any new entities to analyze.
     - Review logs for any errors during the analysis.

4. **Dependency Issues**

   - **Symptom**: Errors related to the OpenAI Python library version.
   - **Solution**:
     - Ensure that the OpenAI library version is `>=1.0.0`.
     - Clear Home Assistant's cache by deleting the `deps` directory and restart.

### **Logging and Debugging**

- Enable debug logging for more detailed information:

  ```yaml
  logger:
    default: warning
    logs:
      custom_components.ai_suggester: debug
      openai: debug
  ```

- View logs under **Settings** > **System** > **Logs**.

---

## Roadmap

We have an ambitious roadmap for the **AI Automation Suggester** integration to enhance its capabilities and provide even more value to Home Assistant users. Below is a list of planned features and improvements:

---

### **Phase 1: Enhanced Entity Analysis**

#### **1. Comprehensive Integration and Sensor Discovery**

- **Objective**: Extend the integration to analyze all available integrations, sensors, and automations in the user's Home Assistant setup.
- **Details**:
  - Collect detailed information about existing entities and their states.
  - Understand the relationships and dependencies between different entities.
  - Identify potential areas where automations could enhance the smart home experience.

#### **2. Advanced Automation Suggestions**

- **Objective**: Provide more powerful and personalized automation suggestions based on the comprehensive analysis.
- **Details**:
  - Use AI to detect patterns and usage habits.
  - Suggest automations that can improve efficiency, security, and convenience.
  - Include suggestions for energy savings, routine automation, and proactive alerts.

---

### **Phase 2: Interactive Suggestion Management**

#### **1. User Feedback Mechanism**

- **Objective**: Allow users to like or dislike the suggested automations to refine future suggestions.
- **Details**:
  - Implement a user interface where suggestions are listed with options to like or dislike.
  - Use feedback to improve the AI model's understanding of user preferences.
  - Store feedback securely and respect user privacy.

#### **2. Detailed Implementation Guides**

- **Objective**: For liked suggestions, provide concise and clear instructions on how to implement the automation.
- **Details**:
  - Break down the steps required to create the automation within Home Assistant.
  - Include code snippets, configuration examples, and screenshots where applicable.
  - Explain the desired outcome and how the automation enhances the user's smart home.

---

### **Phase 3: Automated Automation Creation**

#### **1. One-Click Automation Deployment**

- **Objective**: Enable users to automatically implement the suggested automations directly from the integration.
- **Details**:
  - Integrate with Home Assistant's automation editor to create automations programmatically.
  - Ensure automations are created following best practices and are easily editable by the user.
  - Provide options for users to review and confirm automations before deployment.

#### **2. Safety and Privacy Measures**

- **Objective**: Implement safeguards to ensure that automations are created securely and do not compromise the user's system.
- **Details**:
  - Include confirmation dialogs and summaries before making changes.
  - Ensure the integration adheres to Home Assistant's security guidelines.
  - Provide options to rollback changes if needed.

---

### **Future Enhancements**

#### **1. Local AI Processing**

- **Objective**: Develop local AI processing capabilities to reduce reliance on cloud services.
- **Details**:
  - Explore the use of local machine learning models compatible with Home Assistant's architecture.
  - Improve response times and reduce costs associated with cloud AI usage.
  - Enhance user privacy by keeping data processing local.

#### **2. Multi-Language Support**

- **Objective**: Support multiple languages to cater to a global user base.
- **Details**:
  - Translate the integration's interface and messages into other languages.
  - Ensure AI-generated suggestions are provided in the user's preferred language.
  - Collaborate with the community for translations and localization efforts.

#### **3. Community Integration Sharing**

- **Objective**: Allow users to share their automations and suggestions with the community.
- **Details**:
  - Create a platform or integrate with existing platforms to share and discover automations.
  - Enable users to benefit from community-driven ideas and solutions.
  - Implement moderation and quality control mechanisms.

---

## Contributing to the Roadmap

We welcome contributions and feedback from the community to help shape the future of the **AI Automation Suggester** integration. If you have ideas, feature requests, or would like to contribute to the development, please open an issue or submit a pull request on our [GitHub repository](https://github.com/yourusername/ai_automation_suggester).

---

## Timeline and Updates

We aim to implement these features progressively, with regular updates provided through the repository. Please check back frequently for the latest news and release notes.

---

**Note:** The features listed in this roadmap are subject to change based on feasibility, user feedback, and ongoing development efforts. Our goal is to provide the most valuable and user-friendly experience possible.

---

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## Acknowledgments

- **Home Assistant Community**: For providing an amazing platform and community support.
- **OpenAI**: For their powerful AI models and APIs.

---

## Contributions

Contributions are welcome! Please open an issue or submit a pull request on GitHub.

---

## Disclaimer

This integration is a third-party custom component and is not affiliated with or endorsed by Home Assistant or OpenAI.
name: HACS Action

on:
  push:
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  hacs:
    name: HACS Action
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v2"
      - name: HACS Action
        uses: "hacs/action@main"
        with:
          category: "integration"
name: Validate with hassfest

on:
  push:
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  validate:
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v2"
      - uses: home-assistant/actions/hassfest@master
name: Validate

on:
  push: 
  pull_request:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  validate-hacs:
    runs-on: "ubuntu-latest"
    steps:
      - name: HACS validation
        uses: "hacs/action@main"
        with:
          category: "integration"
"""The AI Automation Suggester integration."""

import logging

from homeassistant.config_entries import ConfigEntry
from homeassistant.core import HomeAssistant

from .const import DOMAIN, PLATFORMS
from .coordinator import AIAutomationCoordinator

_LOGGER = logging.getLogger(__name__)


async def async_setup(hass: HomeAssistant, config: dict):
    """Set up the AI Automation Suggester component."""
    hass.data.setdefault(DOMAIN, {})
    return True


async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry):
    """Set up AI Automation Suggester from a config entry."""
    coordinator = AIAutomationCoordinator(hass, entry)
    hass.data[DOMAIN][entry.entry_id] = coordinator

    await coordinator.async_config_entry_first_refresh()

    await hass.config_entries.async_forward_entry_setups(entry, PLATFORMS)

    async def handle_generate_suggestions(call):
        """Handle the service call to generate suggestions."""
        await coordinator.async_request_refresh()

    hass.services.async_register(DOMAIN, "generate_suggestions", handle_generate_suggestions)

    return True


async def async_unload_entry(hass: HomeAssistant, entry: ConfigEntry):
    """Unload a config entry."""
    unload_ok = await hass.config_entries.async_unload_platforms(entry, PLATFORMS)
    hass.data[DOMAIN].pop(entry.entry_id)
    return unload_ok
"""Config flow for AI Automation Suggester integration."""
import logging

import voluptuous as vol

from homeassistant import config_entries
from homeassistant.core import callback

from .const import DOMAIN

_LOGGER = logging.getLogger(__name__)


class AIAutomationConfigFlow(config_entries.ConfigFlow, domain=DOMAIN):
    """Handle a config flow for AI Automation Suggester."""

    VERSION = 1

    async def async_step_user(self, user_input=None):
        """Handle the initial step."""
        errors = {}
        if user_input is not None:
            # Validate API key if using cloud AI
            if not user_input.get("use_local_ai") and not user_input.get("openai_api_key"):
                errors["openai_api_key"] = "required"
            else:
                return self.async_create_entry(title="AI Automation Suggester", data=user_input)

        data_schema = vol.Schema({
            vol.Required("scan_frequency", default=24): vol.All(vol.Coerce(int), vol.Range(min=1)),
            vol.Required("use_local_ai", default=False): bool,
            vol.Optional("openai_api_key"): str,
        })
        return self.async_show_form(step_id="user", data_schema=data_schema, errors=errors)

    @staticmethod
    @callback
    def async_get_options_flow(config_entry):
        return AIAutomationOptionsFlowHandler(config_entry)


class AIAutomationOptionsFlowHandler(config_entries.OptionsFlow):
    """Handle options flow."""

    def __init__(self, config_entry):
        """Initialize options flow."""
        self.config_entry = config_entry

    async def async_step_init(self, user_input=None):
        """Manage the AI Automation Suggester options."""
        if user_input is not None:
            return self.async_create_entry(title="", data=user_input)

        data_schema = vol.Schema({
            vol.Required("scan_frequency", default=self.config_entry.options.get("scan_frequency", 24)):
                vol.All(vol.Coerce(int), vol.Range(min=1)),
            vol.Required("use_local_ai", default=self.config_entry.options.get("use_local_ai", False)): bool,
            vol.Optional("openai_api_key", default=self.config_entry.options.get("openai_api_key", "")): str,
        })

        return self.async_show_form(step_id="init", data_schema=data_schema)
"""Constants for the AI Automation Suggester integration."""

DOMAIN = "ai_suggester"
PLATFORMS = ["sensor"]
"""Coordinator for AI Automation Suggester."""
import logging
from datetime import timedelta

from homeassistant.components.persistent_notification import async_create
from homeassistant.core import HomeAssistant
from homeassistant.helpers.update_coordinator import DataUpdateCoordinator

from .const import DOMAIN

_LOGGER = logging.getLogger(__name__)


class AIAutomationCoordinator(DataUpdateCoordinator):
    """Class to manage fetching data from AI model."""

    def __init__(self, hass: HomeAssistant, entry):
        """Initialize."""
        self.hass = hass
        self.entry = entry
        update_interval = timedelta(hours=entry.data.get("scan_frequency", 24))
        super().__init__(hass, _LOGGER, name=DOMAIN, update_interval=update_interval)
        self.previous_entities = {}

    async def _async_update_data(self):
        """Fetch data from AI model."""
        # Fetch the list of current entities
        current_entities = {
            entity_id: self.hass.states.get(entity_id).as_dict()
            for entity_id in self.hass.states.async_entity_ids()
        }

        # Detect newly added entities
        new_entities = {
            k: v for k, v in current_entities.items() if k not in self.previous_entities
        }

        # Limit the number of new entities to process
        MAX_NEW_ENTITIES = 10
        total_new_entities = len(new_entities)
        if total_new_entities > MAX_NEW_ENTITIES:
            # Limit the new_entities to MAX_NEW_ENTITIES
            new_entities = dict(list(new_entities.items())[:MAX_NEW_ENTITIES])

        # Prepare data for AI analysis
        ai_input_data = {
            "new_entities": new_entities,
        }

        # Process data with AI model
        suggestions = await self.hass.async_add_executor_job(
            self.get_ai_suggestions, ai_input_data
        )

        # Update previous entities
        self.previous_entities = current_entities

        # Create a persistent notification with suggestions
        if suggestions:
            async_create(
                hass=self.hass,
                title="AI Automation Suggestions",
                message=suggestions,
                notification_id="ai_automation_suggestions"
            )

        return suggestions

    def get_ai_suggestions(self, ai_input_data):
        """Process data with AI model (synchronously)."""
        use_local_ai = self.entry.data.get("use_local_ai", False)
        if use_local_ai:
            # Implement local AI processing
            return self.local_ai_analysis(ai_input_data)
        else:
            # Implement cloud AI processing
            return self.cloud_ai_analysis(ai_input_data)

    def local_ai_analysis(self, ai_input_data):
        """Analyze data using a local AI model."""
        # Placeholder for local AI logic
        return "Local AI analysis is not yet implemented."

    def cloud_ai_analysis(self, ai_input_data):
        """Analyze data using the OpenAI ChatCompletion API."""
        import openai

        api_key = self.entry.data.get("openai_api_key")
        if not api_key:
            _LOGGER.error("OpenAI API key is missing.")
            return "OpenAI API key is missing."

        openai.api_key = api_key

        prompt = self.generate_prompt(ai_input_data)
        try:
            response = openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {
                        "role": "system",
                        "content": "You are an AI assistant that suggests Home Assistant automations based on new entities.",
                    },
                    {"role": "user", "content": prompt},
                ],
                max_tokens=500,
                n=1,
                temperature=0.7,
            )
            suggestions = response.choices[0].message.content.strip()
            return suggestions
        except Exception as e:
            _LOGGER.error(f"Error communicating with OpenAI: {e}")
            return f"Error communicating with OpenAI: {e}"

    def generate_prompt(self, ai_input_data):
        """Generate prompt for AI model."""
        # Simplify the data to make the prompt manageable
        new_entities_list = [
            f"{entity_id}: {entity['state']}"
            for entity_id, entity in ai_input_data['new_entities'].items()
        ]

        # Limit the number of entities included
        MAX_ENTITIES = 10
        total_new_entities = len(new_entities_list)
        if total_new_entities > MAX_ENTITIES:
            new_entities_list = new_entities_list[:MAX_ENTITIES]
            entities_info = f"{MAX_ENTITIES} of {total_new_entities} new entities"
        else:
            entities_info = f"{total_new_entities} new entities"

        prompt = (
            f"Analyze the following {entities_info} added to my Home Assistant setup and suggest potential automations:\n"
        )
        prompt += "\n".join(new_entities_list)
        prompt += "\n\nProvide the suggestions in a clear and concise manner."
        return prompt
{
  "domain": "ai_suggester",
  "name": "AI Automation Suggester",
  "version": "1.0.0",
  "documentation": "https://github.com/ITSpecialist111/ai_automation_suggester",
  "requirements": ["openai>=1.0.0,<2.0.0"],
  "dependencies": [],
  "codeowners": ["@yITSpecialist111"],
  "iot_class": "cloud_polling",
  "config_flow": true
}
"""Sensor platform for AI Automation Suggester."""
from homeassistant.components.sensor import SensorEntity
from homeassistant.helpers.update_coordinator import CoordinatorEntity

from .const import DOMAIN


async def async_setup_entry(hass, entry, async_add_entities):
    """Set up the sensor platform."""
    coordinator = hass.data[DOMAIN][entry.entry_id]
    async_add_entities([AISuggestionsSensor(coordinator)], True)


class AISuggestionsSensor(CoordinatorEntity, SensorEntity):
    """Sensor to display AI suggestions."""

    def __init__(self, coordinator):
        """Initialize the sensor."""
        super().__init__(coordinator)
        self._attr_name = "AI Automation Suggestions"
        self._attr_unique_id = "ai_automation_suggestions_sensor"
        self._attr_icon = "mdi:robot"

    @property
    def state(self):
        """Return the state of the sensor."""
        if self.coordinator.data:
            return "Suggestions Available"
        return "No Suggestions"

    @property
    def extra_state_attributes(self):
        """Return the state attributes."""
        return {"suggestions": self.coordinator.data}
generate_suggestions:
  description: "Manually trigger AI automation suggestions."
  fields: {}
{
  "title": "AI Automation Suggester",
  "config": {
    "step": {
      "user": {
        "title": "Configure AI Automation Suggester",
        "data": {
          "scan_frequency": "Scan Frequency (hours)",
          "use_local_ai": "Use Local AI (Work In Progress)",
          "openai_api_key": "OpenAI API Key"
        }
      }
    },
    "error": {
      "required": "This field is required."
    }
  }
}
{
  "config": {
    "step": {
      "user": {
        "title": "Configure AI Automation Suggester",
        "data": {
          "scan_frequency": "Scan Frequency (hours)",
          "use_local_ai": "Use Local AI",
          "openai_api_key": "OpenAI API Key"
        }
      }
    },
    "error": {
      "required": "This field is required."
    }
  }
}
class AISuggesterCard extends HTMLElement {
  
  // Proper implementation of setConfig
  setConfig(config) {
    if (!config) {
      throw new Error("Invalid configuration");
    }
    this.config = config;
    this.renderCard();
  }

  set hass(hass) {
    this._hass = hass;
    if (this.config) {
      this.renderCard();
    }
  }

  renderCard() {
    if (!this.content) {
      const card = document.createElement('ha-card');
      card.header = 'AI Automation Suggestions';
      this.content = document.createElement('div');
      this.content.style.padding = '16px';
      card.appendChild(this.content);
      this.appendChild(card);
    }
    if (this._hass) {
      this._hass.callApi('GET', 'ai_suggester/suggestions').then((suggestions) => {
        this.renderSuggestions(suggestions);
      });
    }
  }

  renderSuggestions(suggestions) {
    this.content.innerHTML = '';
    suggestions.suggestions.forEach((suggestion, index) => {
      const suggestionDiv = document.createElement('div');
      suggestionDiv.style.marginBottom = '16px';

      const description = document.createElement('p');
      description.textContent = suggestion.description;
      suggestionDiv.appendChild(description);

      const acceptButton = document.createElement('mwc-button');
      acceptButton.textContent = 'Accept';
      acceptButton.addEventListener('click', () => this.acceptSuggestion(index));
      suggestionDiv.appendChild(acceptButton);

      const rejectButton = document.createElement('mwc-button');
      rejectButton.textContent = 'Reject';
      rejectButton.addEventListener('click', () => this.rejectSuggestion(index));
      suggestionDiv.appendChild(rejectButton);

      this.content.appendChild(suggestionDiv);
    });
  }

  acceptSuggestion(index) {
    this._hass.callService('ai_suggester', 'accept_suggestion', { index });
  }

  rejectSuggestion(index) {
    this._hass.callService('ai_suggester', 'reject_suggestion', { index });
  }
}

customElements.define('ai-suggester-card', AISuggesterCard);
{
  "name": "AI Suggester",
  "version": "1.0",
  "slug": "ai_suggester",
  "description": "Custom AI-powered automation suggester for Home Assistant",
  "arch": ["armv7", "amd64"],
  "startup": "application",
  "boot": "auto",
  "options": {},
  "schema": {}
}
{
    "name": "AI Automation Suggester",
    "content_in_root": false,
    "homeassistant": "2024.10.2"
  }
{
    "name": "AI Suggester Add-ons",
    "url": "https://github.com/ITSpecialist111/ai_suggester"
  }
pytest
pytest-cov==2.9.0
pytest-homeassistant-custom-component
# AI Automation Suggester

An integration for Home Assistant that uses OpenAI's GPT models to analyze your newly added entities and suggest potential automations.

---

## Support the Project

If you find this project helpful and would like to support its development, you can buy me a coffee!

<a href="https://buymeacoffee.com/itspecialist">
  <img src="https://camo.githubusercontent.com/7b8f7343bfc6e3c65c7901846637b603fd812f1a5f768d8b0572558bde859eb9/68747470733a2f2f63646e2e6275796d6561636f666665652e636f6d2f627574746f6e732f76322f64656661756c742d79656c6c6f772e706e67" alt="Buy Me A Coffee" width="200">
</a>

Your support is greatly appreciated and helps maintain and improve this project!

---

## Table of Contents

- [Background and Purpose](#background-and-purpose)
- [Features](#features)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
- [Usage](#usage)
- [Important Notes](#important-notes)
- [Troubleshooting](#troubleshooting)
- [Roadmap](#roadmap)
  - [Phase 1: Enhanced Entity Analysis](#phase-1-enhanced-entity-analysis)
  - [Phase 2: Interactive Suggestion Management](#phase-2-interactive-suggestion-management)
  - [Phase 3: Automated Automation Creation](#phase-3-automated-automation-creation)
  - [Future Enhancements](#future-enhancements)
  - [Contributing to the Roadmap](#contributing-to-the-roadmap)
  - [Timeline and Updates](#timeline-and-updates)
- [License](#license)
- [Acknowledgments](#acknowledgments)
- [Contributions](#contributions)
- [Disclaimer](#disclaimer)
- [Support the Project](#support-the-project)

---

## Background and Purpose

Managing and automating devices in a smart home can be complex, especially as the number of devices grows. The **AI Automation Suggester** integration aims to simplify this process by leveraging OpenAI's GPT models to analyze newly added entities in your Home Assistant setup and provide intelligent automation suggestions. We call it the ultimate 'Matt' mode (only because he's the one who asked for it)

---

## Features

- **Automatic Analysis**: Periodically scans for new entities and analyzes them using AI.
- **Automation Suggestions**: Provides clear and concise suggestions for potential automations.
- **Manual Trigger**: Allows you to manually trigger the AI analysis at any time.
- **Persistent Notifications**: Suggestions are delivered via Home Assistant's persistent notifications.
- **Sensor Entity**: Creates a sensor entity to display the status and suggestions.
- **Configurable Scan Frequency**: Set how often the integration scans for new entities.
- **Supports OpenAI GPT Models**: Uses OpenAI's GPT models for analysis.
- **Local AI Option**: Placeholder for future local AI processing capabilities.

---

## Prerequisites

- **Home Assistant**: Version 2023.5 or later.
- **OpenAI API Key**: You need an OpenAI API key to use the cloud AI processing.

---

## Installation

### Method 1: Manual Installation (Recommended)

If you prefer to install the integration manually, follow these steps:

1. **Download the Integration**
   - Clone or download the `ai_automation_suggester` repository from GitHub.

2. **Copy to Home Assistant**
   - Place the `ai_suggester` directory inside the `custom_components` directory of your Home Assistant configuration folder.
   - Your directory structure should look like this:

     ```
     â””â”€â”€ config/
         â”œâ”€â”€ configuration.yaml
         â””â”€â”€ custom_components/
             â””â”€â”€ ai_suggester/
                 â”œâ”€â”€ __init__.py
                 â”œâ”€â”€ config_flow.py
                 â”œâ”€â”€ const.py
                 â”œâ”€â”€ coordinator.py
                 â”œâ”€â”€ manifest.json
                 â”œâ”€â”€ sensor.py
                 â”œâ”€â”€ services.yaml
                 â”œâ”€â”€ strings.json
                 â””â”€â”€ translations/
                     â””â”€â”€ en.json
     ```

   - If the `custom_components` directory doesn't exist, create it.

3. **Restart Home Assistant**
   - After copying the files, restart Home Assistant to recognize the new integration.

---

## Configuration

### 1. **Add the Integration via Home Assistant UI**

- Navigate to **Settings** > **Devices & Services**.
- Click on **Add Integration**.
- Search for **AI Automation Suggester** and select it.

### 2. **Configure the Integration**

- **Scan Frequency (hours)**: Set how often (in hours) the integration scans for new entities. Default is `24` hours.
- **Use Local AI**: Option to use local AI processing (currently not implemented).
- **OpenAI API Key**: Enter your OpenAI API key. This is required if not using local AI.
- **AI Model**: Select your preferred AI model from the dropdown. Options include:

  - **gpt-3.5-turbo**: Cheap
  - **gpt-4o**: High Quality
  - **o1-mini**: Expensive
  - **gpt-4o-mini**: Recommended
  - **o1-preview**: Very Expensive

  **Note**: The choice of AI model affects the cost and quality of the suggestions. Higher-end models like `gpt-4o-mini` may provide better suggestions but at a higher cost.

### 3. **Obtain an OpenAI API Key**

- Log in or sign up at the [OpenAI Platform](https://platform.openai.com/).
- Navigate to the [API Keys page](https://platform.openai.com/account/api-keys).
- Click on **Create new secret key** and copy the key.
- **Important**: Keep your API key secure and do not share it publicly.

---

## Usage

### 1. **Automatic Suggestions**

- The integration will automatically scan for new entities based on the configured scan frequency.
- When new entities are detected, it will analyze them and create automation suggestions.

### 2. **Manual Trigger**

- You can manually trigger the AI analysis at any time:
  - Go to **Developer Tools** > **Services**.
  - Select `ai_suggester.generate_suggestions` from the list.
  - Click **Call Service**.

### 3. **Viewing Suggestions**

- Suggestions are delivered via Home Assistant's persistent notifications.
- You can also view suggestions in the `sensor.ai_automation_suggestions` entity's attributes.

### 4. **Adding to Lovelace Dashboard**

- You can display the suggestions on your dashboard using an **Entities** card:

  ```yaml
  type: entities
  entities:
    - entity: sensor.ai_automation_suggestions
  ```

---

## Important Notes

### **OpenAI API Key Security**

- **Do Not Share Your API Key**: Keep your OpenAI API key confidential.
- **Revoking Compromised Keys**: If you suspect your API key has been compromised, revoke it immediately and generate a new one.

### **OpenAI API Usage**

- **Costs**: Using the OpenAI API may incur costs. Monitor your usage in the [OpenAI Dashboard](https://platform.openai.com/account/usage).
- **Usage Limits**: Set usage limits in your OpenAI account to avoid unexpected charges.

### **Compatibility**

- **OpenAI Python Library**: The integration requires `openai>=1.0.0`. This is specified in the `manifest.json`.
- **Home Assistant Version**: Ensure you are running Home Assistant version 2023.5 or later.

### **Data Privacy**

- **Data Sent to OpenAI**: The integration sends entity information to OpenAI's API for analysis.
- **User Consent**: By using this integration, you consent to this data being sent to OpenAI.

### **Local AI Processing**

- **Not Yet Implemented**: The option to use local AI is currently a placeholder and not functional.
- **Future Updates**: Stay tuned for updates that may include local AI processing capabilities.

---

## Troubleshooting

### **Common Issues**

1. **OpenAI API Errors**

   - **Symptom**: Error messages related to OpenAI API in notifications or logs.
   - **Solution**:
     - Verify your OpenAI API key is correct.
     - Ensure your API key has not expired or been revoked.
     - Check your OpenAI account for any usage limits or account issues.

2. **Integration Not Showing Up**

   - **Symptom**: After installation, the integration doesn't appear in Home Assistant.
   - **Solution**:
     - Ensure the `ai_suggester` directory is in the correct location.
     - Restart Home Assistant after adding the custom component.
     - Check the logs for any errors during startup.

3. **No Suggestions Generated**

   - **Symptom**: The integration doesn't generate any suggestions.
   - **Solution**:
     - Manually trigger the service `ai_suggester.generate_suggestions`.
     - Check if there are any new entities to analyze.
     - Review logs for any errors during the analysis.

4. **Dependency Issues**

   - **Symptom**: Errors related to the OpenAI Python library version.
   - **Solution**:
     - Ensure that the OpenAI library version is `>=1.0.0`.
     - Clear Home Assistant's cache by deleting the `deps` directory and restart.

### **Logging and Debugging**

- Enable debug logging for more detailed information:

  ```yaml
  logger:
    default: warning
    logs:
      custom_components.ai_suggester: debug
      openai: debug
  ```

- View logs under **Settings** > **System** > **Logs**.

---

## Roadmap

We have an ambitious roadmap for the **AI Automation Suggester** integration to enhance its capabilities and provide even more value to Home Assistant users. Below is a list of planned features and improvements:

---

### **Phase 1: Enhanced Entity Analysis**

#### **1. Comprehensive Integration and Sensor Discovery**

- **Objective**: Extend the integration to analyze all available integrations, sensors, and automations in the user's Home Assistant setup.
- **Details**:
  - Collect detailed information about existing entities and their states.
  - Understand the relationships and dependencies between different entities.
  - Identify potential areas where automations could enhance the smart home experience.

#### **2. Advanced Automation Suggestions**

- **Objective**: Provide more powerful and personalized automation suggestions based on the comprehensive analysis.
- **Details**:
  - Use AI to detect patterns and usage habits.
  - Suggest automations that can improve efficiency, security, and convenience.
  - Include suggestions for energy savings, routine automation, and proactive alerts.

---

### **Phase 2: Interactive Suggestion Management**

#### **1. User Feedback Mechanism**

- **Objective**: Allow users to like or dislike the suggested automations to refine future suggestions.
- **Details**:
  - Implement a user interface where suggestions are listed with options to like or dislike.
  - Use feedback to improve the AI model's understanding of user preferences.
  - Store feedback securely and respect user privacy.

#### **2. Detailed Implementation Guides**

- **Objective**: For liked suggestions, provide concise and clear instructions on how to implement the automation.
- **Details**:
  - Break down the steps required to create the automation within Home Assistant.
  - Include code snippets, configuration examples, and screenshots where applicable.
  - Explain the desired outcome and how the automation enhances the user's smart home.

---

### **Phase 3: Automated Automation Creation**

#### **1. One-Click Automation Deployment**

- **Objective**: Enable users to automatically implement the suggested automations directly from the integration.
- **Details**:
  - Integrate with Home Assistant's automation editor to create automations programmatically.
  - Ensure automations are created following best practices and are easily editable by the user.
  - Provide options for users to review and confirm automations before deployment.

#### **2. Safety and Privacy Measures**

- **Objective**: Implement safeguards to ensure that automations are created securely and do not compromise the user's system.
- **Details**:
  - Include confirmation dialogs and summaries before making changes.
  - Ensure the integration adheres to Home Assistant's security guidelines.
  - Provide options to rollback changes if needed.

---

### **Future Enhancements**

#### **1. Local AI Processing**

- **Objective**: Develop local AI processing capabilities to reduce reliance on cloud services.
- **Details**:
  - Explore the use of local machine learning models compatible with Home Assistant's architecture.
  - Improve response times and reduce costs associated with cloud AI usage.
  - Enhance user privacy by keeping data processing local.

#### **2. Multi-Language Support**

- **Objective**: Support multiple languages to cater to a global user base.
- **Details**:
  - Translate the integration's interface and messages into other languages.
  - Ensure AI-generated suggestions are provided in the user's preferred language.
  - Collaborate with the community for translations and localization efforts.

#### **3. Community Integration Sharing**

- **Objective**: Allow users to share their automations and suggestions with the community.
- **Details**:
  - Create a platform or integrate with existing platforms to share and discover automations.
  - Enable users to benefit from community-driven ideas and solutions.
  - Implement moderation and quality control mechanisms.

---

## Contributing to the Roadmap

We welcome contributions and feedback from the community to help shape the future of the **AI Automation Suggester** integration. If you have ideas, feature requests, or would like to contribute to the development, please open an issue or submit a pull request on our [GitHub repository](https://github.com/yourusername/ai_automation_suggester).

---

## Timeline and Updates

We aim to implement these features progressively, with regular updates provided through the repository. Please check back frequently for the latest news and release notes.

---

**Note:** The features listed in this roadmap are subject to change based on feasibility, user feedback, and ongoing development efforts. Our goal is to provide the most valuable and user-friendly experience possible.

---

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## Acknowledgments

- **Home Assistant Community**: For providing an amazing platform and community support.
- **OpenAI**: For their powerful AI models and APIs.

---

## Contributions

Contributions are welcome! Please open an issue or submit a pull request on GitHub.

---

## Disclaimer

This integration is a third-party custom component and is not affiliated with or endorsed by Home Assistant or OpenAI.

name: HACS Action

on:
  push:
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  hacs:
    name: HACS Action
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v2"
      - name: HACS Action
        uses: "hacs/action@main"
        with:
          category: "integration"
name: Validate with hassfest

on:
  push:
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  validate:
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v2"
      - uses: home-assistant/actions/hassfest@master
name: Validate

on:
  push: 
  pull_request:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  validate-hacs:
    runs-on: "ubuntu-latest"
    steps:
      - name: HACS validation
        uses: "hacs/action@main"
        with:
          category: "integration"
"""The AI Automation Suggester integration."""

import logging

from homeassistant.config_entries import ConfigEntry
from homeassistant.core import HomeAssistant

from .const import DOMAIN, PLATFORMS
from .coordinator import AIAutomationCoordinator

_LOGGER = logging.getLogger(__name__)


async def async_setup(hass: HomeAssistant, config: dict):
    """Set up the AI Automation Suggester component."""
    hass.data.setdefault(DOMAIN, {})
    return True


async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry):
    """Set up AI Automation Suggester from a config entry."""
    coordinator = AIAutomationCoordinator(hass, entry)
    hass.data[DOMAIN][entry.entry_id] = coordinator

    await coordinator.async_config_entry_first_refresh()

    await hass.config_entries.async_forward_entry_setups(entry, PLATFORMS)

    async def handle_generate_suggestions(call):
        """Handle the service call to generate suggestions."""
        await coordinator.async_request_refresh()

    hass.services.async_register(DOMAIN, "generate_suggestions", handle_generate_suggestions)

    return True


async def async_unload_entry(hass: HomeAssistant, entry: ConfigEntry):
    """Unload a config entry."""
    unload_ok = await hass.config_entries.async_unload_platforms(entry, PLATFORMS)
    hass.data[DOMAIN].pop(entry.entry_id)
    return unload_ok

"""Config flow for AI Automation Suggester integration."""
import logging

import voluptuous as vol

from homeassistant import config_entries
from homeassistant.core import callback

from .const import DOMAIN

_LOGGER = logging.getLogger(__name__)


class AIAutomationConfigFlow(config_entries.ConfigFlow, domain=DOMAIN):
    """Handle a config flow for AI Automation Suggester."""

    VERSION = 1

    async def async_step_user(self, user_input=None):
        """Handle the initial step."""
        errors = {}
        if user_input is not None:
            # Validate API key if using cloud AI
            if not user_input.get("use_local_ai") and not user_input.get("openai_api_key"):
                errors["openai_api_key"] = "required"
            else:
                return self.async_create_entry(title="AI Automation Suggester", data=user_input)

        data_schema = vol.Schema({
            vol.Required("scan_frequency", default=24): vol.All(vol.Coerce(int), vol.Range(min=1)),
            vol.Required("use_local_ai", default=False): bool,
            vol.Optional("openai_api_key"): str,
        })
        return self.async_show_form(step_id="user", data_schema=data_schema, errors=errors)

    @staticmethod
    @callback
    def async_get_options_flow(config_entry):
        return AIAutomationOptionsFlowHandler(config_entry)


class AIAutomationOptionsFlowHandler(config_entries.OptionsFlow):
    """Handle options flow."""

    def __init__(self, config_entry):
        """Initialize options flow."""
        self.config_entry = config_entry

    async def async_step_init(self, user_input=None):
        """Manage the AI Automation Suggester options."""
        if user_input is not None:
            return self.async_create_entry(title="", data=user_input)

        data_schema = vol.Schema({
            vol.Required("scan_frequency", default=self.config_entry.options.get("scan_frequency", 24)):
                vol.All(vol.Coerce(int), vol.Range(min=1)),
            vol.Required("use_local_ai", default=self.config_entry.options.get("use_local_ai", False)): bool,
            vol.Optional("openai_api_key", default=self.config_entry.options.get("openai_api_key", "")): str,
        })

        return self.async_show_form(step_id="init", data_schema=data_schema)

"""Constants for the AI Automation Suggester integration."""

DOMAIN = "ai_suggester"
PLATFORMS = ["sensor"]

"""Coordinator for AI Automation Suggester."""
import logging
from datetime import timedelta

from homeassistant.components.persistent_notification import async_create
from homeassistant.core import HomeAssistant
from homeassistant.helpers.update_coordinator import DataUpdateCoordinator

from .const import DOMAIN

_LOGGER = logging.getLogger(__name__)


class AIAutomationCoordinator(DataUpdateCoordinator):
    """Class to manage fetching data from AI model."""

    def __init__(self, hass: HomeAssistant, entry):
        """Initialize."""
        self.hass = hass
        self.entry = entry
        update_interval = timedelta(hours=entry.data.get("scan_frequency", 24))
        super().__init__(hass, _LOGGER, name=DOMAIN, update_interval=update_interval)
        self.previous_entities = {}

    async def _async_update_data(self):
        """Fetch data from AI model."""
        # Fetch the list of current entities
        current_entities = {
            entity_id: self.hass.states.get(entity_id).as_dict()
            for entity_id in self.hass.states.async_entity_ids()
        }

        # Detect newly added entities
        new_entities = {
            k: v for k, v in current_entities.items() if k not in self.previous_entities
        }

        # Limit the number of new entities to process
        MAX_NEW_ENTITIES = 10
        total_new_entities = len(new_entities)
        if total_new_entities > MAX_NEW_ENTITIES:
            # Limit the new_entities to MAX_NEW_ENTITIES
            new_entities = dict(list(new_entities.items())[:MAX_NEW_ENTITIES])

        # Prepare data for AI analysis
        ai_input_data = {
            "new_entities": new_entities,
        }

        # Process data with AI model
        suggestions = await self.hass.async_add_executor_job(
            self.get_ai_suggestions, ai_input_data
        )

        # Update previous entities
        self.previous_entities = current_entities

        # Create a persistent notification with suggestions
        if suggestions:
            async_create(
                hass=self.hass,
                title="AI Automation Suggestions",
                message=suggestions,
                notification_id="ai_automation_suggestions"
            )

        return suggestions

    def get_ai_suggestions(self, ai_input_data):
        """Process data with AI model (synchronously)."""
        use_local_ai = self.entry.data.get("use_local_ai", False)
        if use_local_ai:
            # Implement local AI processing
            return self.local_ai_analysis(ai_input_data)
        else:
            # Implement cloud AI processing
            return self.cloud_ai_analysis(ai_input_data)

    def local_ai_analysis(self, ai_input_data):
        """Analyze data using a local AI model."""
        # Placeholder for local AI logic
        return "Local AI analysis is not yet implemented."

    def cloud_ai_analysis(self, ai_input_data):
        """Analyze data using the OpenAI ChatCompletion API."""
        import openai

        api_key = self.entry.data.get("openai_api_key")
        if not api_key:
            _LOGGER.error("OpenAI API key is missing.")
            return "OpenAI API key is missing."

        openai.api_key = api_key

        prompt = self.generate_prompt(ai_input_data)
        try:
            response = openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {
                        "role": "system",
                        "content": "You are an AI assistant that suggests Home Assistant automations based on new entities.",
                    },
                    {"role": "user", "content": prompt},
                ],
                max_tokens=500,
                n=1,
                temperature=0.7,
            )
            suggestions = response.choices[0].message.content.strip()
            return suggestions
        except Exception as e:
            _LOGGER.error(f"Error communicating with OpenAI: {e}")
            return f"Error communicating with OpenAI: {e}"

    def generate_prompt(self, ai_input_data):
        """Generate prompt for AI model."""
        # Simplify the data to make the prompt manageable
        new_entities_list = [
            f"{entity_id}: {entity['state']}"
            for entity_id, entity in ai_input_data['new_entities'].items()
        ]

        # Limit the number of entities included
        MAX_ENTITIES = 10
        total_new_entities = len(new_entities_list)
        if total_new_entities > MAX_ENTITIES:
            new_entities_list = new_entities_list[:MAX_ENTITIES]
            entities_info = f"{MAX_ENTITIES} of {total_new_entities} new entities"
        else:
            entities_info = f"{total_new_entities} new entities"

        prompt = (
            f"Analyze the following {entities_info} added to my Home Assistant setup and suggest potential automations:\n"
        )
        prompt += "\n".join(new_entities_list)
        prompt += "\n\nProvide the suggestions in a clear and concise manner."
        return prompt

{
  "domain": "ai_suggester",
  "name": "AI Automation Suggester",
  "version": "1.0.0",
  "documentation": "https://github.com/ITSpecialist111/ai_automation_suggester",
  "requirements": ["openai>=1.0.0,<2.0.0"],
  "dependencies": [],
  "codeowners": ["@yITSpecialist111"],
  "iot_class": "cloud_polling",
  "config_flow": true
}

"""Sensor platform for AI Automation Suggester."""
from homeassistant.components.sensor import SensorEntity
from homeassistant.helpers.update_coordinator import CoordinatorEntity

from .const import DOMAIN


async def async_setup_entry(hass, entry, async_add_entities):
    """Set up the sensor platform."""
    coordinator = hass.data[DOMAIN][entry.entry_id]
    async_add_entities([AISuggestionsSensor(coordinator)], True)


class AISuggestionsSensor(CoordinatorEntity, SensorEntity):
    """Sensor to display AI suggestions."""

    def __init__(self, coordinator):
        """Initialize the sensor."""
        super().__init__(coordinator)
        self._attr_name = "AI Automation Suggestions"
        self._attr_unique_id = "ai_automation_suggestions_sensor"
        self._attr_icon = "mdi:robot"

    @property
    def state(self):
        """Return the state of the sensor."""
        if self.coordinator.data:
            return "Suggestions Available"
        return "No Suggestions"

    @property
    def extra_state_attributes(self):
        """Return the state attributes."""
        return {"suggestions": self.coordinator.data}

generate_suggestions:
  description: "Manually trigger AI automation suggestions."
  fields: {}

{
  "title": "AI Automation Suggester",
  "config": {
    "step": {
      "user": {
        "title": "Configure AI Automation Suggester",
        "data": {
          "scan_frequency": "Scan Frequency (hours)",
          "use_local_ai": "Use Local AI (Work In Progress)",
          "openai_api_key": "OpenAI API Key"
        }
      }
    },
    "error": {
      "required": "This field is required."
    }
  }
}

{
  "config": {
    "step": {
      "user": {
        "title": "Configure AI Automation Suggester",
        "data": {
          "scan_frequency": "Scan Frequency (hours)",
          "use_local_ai": "Use Local AI",
          "openai_api_key": "OpenAI API Key"
        }
      }
    },
    "error": {
      "required": "This field is required."
    }
  }
}

class AISuggesterCard extends HTMLElement {
  
  // Proper implementation of setConfig
  setConfig(config) {
    if (!config) {
      throw new Error("Invalid configuration");
    }
    this.config = config;
    this.renderCard();
  }

  set hass(hass) {
    this._hass = hass;
    if (this.config) {
      this.renderCard();
    }
  }

  renderCard() {
    if (!this.content) {
      const card = document.createElement('ha-card');
      card.header = 'AI Automation Suggestions';
      this.content = document.createElement('div');
      this.content.style.padding = '16px';
      card.appendChild(this.content);
      this.appendChild(card);
    }
    if (this._hass) {
      this._hass.callApi('GET', 'ai_suggester/suggestions').then((suggestions) => {
        this.renderSuggestions(suggestions);
      });
    }
  }

  renderSuggestions(suggestions) {
    this.content.innerHTML = '';
    suggestions.suggestions.forEach((suggestion, index) => {
      const suggestionDiv = document.createElement('div');
      suggestionDiv.style.marginBottom = '16px';

      const description = document.createElement('p');
      description.textContent = suggestion.description;
      suggestionDiv.appendChild(description);

      const acceptButton = document.createElement('mwc-button');
      acceptButton.textContent = 'Accept';
      acceptButton.addEventListener('click', () => this.acceptSuggestion(index));
      suggestionDiv.appendChild(acceptButton);

      const rejectButton = document.createElement('mwc-button');
      rejectButton.textContent = 'Reject';
      rejectButton.addEventListener('click', () => this.rejectSuggestion(index));
      suggestionDiv.appendChild(rejectButton);

      this.content.appendChild(suggestionDiv);
    });
  }

  acceptSuggestion(index) {
    this._hass.callService('ai_suggester', 'accept_suggestion', { index });
  }

  rejectSuggestion(index) {
    this._hass.callService('ai_suggester', 'reject_suggestion', { index });
  }
}

customElements.define('ai-suggester-card', AISuggesterCard);

{
  "name": "AI Suggester",
  "version": "1.0",
  "slug": "ai_suggester",
  "description": "Custom AI-powered automation suggester for Home Assistant",
  "arch": ["armv7", "amd64"],
  "startup": "application",
  "boot": "auto",
  "options": {},
  "schema": {}
}

{
    "name": "AI Automation Suggester",
    "content_in_root": false,
    "homeassistant": "2024.10.2"
  }
{
    "name": "AI Suggester Add-ons",
    "url": "https://github.com/ITSpecialist111/ai_suggester"
  }

pytest
pytest-cov==2.9.0
pytest-homeassistant-custom-component

